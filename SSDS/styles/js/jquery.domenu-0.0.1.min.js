/**
 * @license Copyright Â© 2015 Mateusz Zawartka
 * MIT license
 */
!function($,window,document,undefined){function Plugin(element,options){this.w=$(document),this.el=$(element),this.options=$.extend({},defaults,options),this.init()}function PublicPlugin(plugin,lists){if(!plugin)throw new TypeError("expected object, got "+typeof plugin);this._plugin=plugin,this._lists=lists}var hasTouch="ontouchstart"in document,hasPointerEvents=function(){var el=document.createElement("div"),docEl=document.documentElement;if(!("pointerEvents"in el.style))return!1;el.style.pointerEvents="auto",el.style.pointerEvents="x",docEl.appendChild(el);var supports=window.getComputedStyle&&"auto"===window.getComputedStyle(el,"").pointerEvents;return docEl.removeChild(el),!!supports}(),defaults={listNodeName:"ol",itemNodeName:"li",rootClass:"dd",listClass:"dd-list",itemClass:"dd-item",dragClass:"dd-dragel",handleClass:"dd-handle",collapsedClass:"dd-collapsed",placeClass:"dd-placeholder",noDragClass:"dd-nodrag",emptyClass:"dd-empty",expandBtnHTML:'<button data-action="expand" type="button">+</button>',collapseBtnHTML:'<button data-action="collapse" type="button">-</button>',editBtnHTML:'<button data-action="edit" type="button">edit</button>',data:"",group:0,maxDepth:5,threshold:20};Plugin.prototype={init:function(){var list=this;list.reset(),list.el.data("domenu-group",this.options.group),list.placeEl=$('<div class="'+list.options.placeClass+'"/>'),$.each(this.el.find(list.options.itemNodeName),function(k,el){list.setParent($(el))}),list.el.on("click","button",function(e){if(!list.dragEl){var target=$(e.currentTarget),action=target.data("action"),item=target.parent(list.options.itemNodeName);"collapse"===action&&list.collapseItem(item),"expand"===action&&list.expandItem(item)}});var onStartEvent=function(e){var handle=$(e.target);if(!handle.hasClass(list.options.handleClass)){if(handle.closest("."+list.options.noDragClass).length)return;handle=handle.closest("."+list.options.handleClass)}handle.length&&!list.dragEl&&(list.isTouch=/^touch/.test(e.type),list.isTouch&&1!==e.touches.length||(e.preventDefault(),list.dragStart(e.touches?e.touches[0]:e)))},onMoveEvent=function(e){list.dragEl&&(e.preventDefault(),list.dragMove(e.touches?e.touches[0]:e))},onEndEvent=function(e){list.dragEl&&(e.preventDefault(),list.dragStop(e.touches?e.touches[0]:e))};hasTouch&&(list.el[0].addEventListener("touchstart",onStartEvent,!1),window.addEventListener("touchmove",onMoveEvent,!1),window.addEventListener("touchend",onEndEvent,!1),window.addEventListener("touchcancel",onEndEvent,!1)),list.el.on("mousedown",onStartEvent),list.w.on("mousemove",onMoveEvent),list.w.on("mouseup",onEndEvent),this.startEditListener($(".dd3-content span")),this.endEditListener($(".dd3-content .dd-edit-box input")),this.addNewListItemListener(this.el.find(".dd-new-item"))},addNewListItemListener:function(el,parent){var _this=this,opt=this.options;el.on("click",function(e){$("."+opt.rootClass).find("."+opt.listClass).first().prepend(_this.createNewListItem())})},startEditListener:function(el){el.on("click",function(e){var e=$(this);e.add(e.parent().find(".item-remove").first()).slideToggle(50,function(){if("SPAN"===this.nodeName){var edb=e.parent().children(".dd-edit-box").first();"no title"!==e.text()&&edb.children('input[name="title"]').first().val(e.text()),edb.slideToggle(50,function(){edb.children().first("input").focus()})}})})},endEditListener:function(el){var opt=this.options;el.on("keypress",function(e){if(13===e.keyCode){var spn=$(e.target).parents(".dd3-content").children("span").first(),removeBtn=$(this).parent().find(".item-remove");removeBtn.slideToggle(),spn.text($(this).parents().first().children('input[name="title"]').val()),""===spn.text()&&spn.text("no title"),$(e.target).parents(".dd3-content").children(".dd-edit-box").first().slideToggle(50,function(){var rmvBtn=$(e.target).parents(".dd3-content").find(".item-remove").first(),edtBox=$(e.target).parents(".dd-edit-box").first(),title=edtBox.find('input[name="title"]').first().val(),http=edtBox.find('input[name="http"]').first().val(),item=edtBox.parents(opt.itemNodeName).first();item.data("title",title).data("http",http),spn.add(rmvBtn).slideToggle(50)})}})},createNewListItem:function(id,title,http){var id="undefined"!=typeof id?id:this.getHighestId()+1,title="undefined"!=typeof title?title:"Item "+id,http="undefined"!=typeof http?http:"",el=this.el,opt=this.options,blueprint=el.find(".dd-item-blueprint").first().clone();return blueprint.data("id",id),blueprint.attr("class",opt.itemClass),blueprint.find("span").first().text(title),blueprint.find('input[name="title"]').first().val(title),blueprint.data("title",title),blueprint.find('input[name="http"]').first().val(http),blueprint.data("http",http),blueprint.find(".item-remove").first().on("click",function(e){blueprint.remove()}),this.startEditListener(blueprint.find("span").first()),this.endEditListener(blueprint.find(".dd-edit-box input")),this.endEditListener(blueprint.find(".dd-edit-box i").first()),blueprint},getHighestId:function(){var opt=this.options,el=this.el,id=0;return el.find(opt.itemNodeName).each(function(i,e){var eId=$(e).data("id");return eId>id?id=eId:void 0}),id},serialize:function(){var data,depth=0,list=this;return step=function(level,depth){var array=[],items=level.children(list.options.itemNodeName);return items.each(function(){var li=$(this),item=$.extend({},li.data()),sub=li.children(list.options.listNodeName);sub.length&&(item.children=step(sub,depth+1)),array.push(item)}),array},data=step(list.el.find(list.options.listNodeName).first(),depth)},deserialize:function(data,override){var data=JSON.parse(data)||JSON.parse(this.options.data),_this=this,list=_this.el.find(".dd-list").first();override&&list.children().remove();var processItem=function(i,pref){if(i.children){var cref=$('<ol class="dd-list"></ol>'),item=_this.createNewListItem(i.id,i.title,i.http);pref.append(item),item.append(cref),_this.setParent(item,!0),jQuery.each(i.children,function(i,e){processItem(e,cref)})}else{var item=_this.createNewListItem(i.id,i.title,i.http);pref.append(item)}};jQuery.each(data,function(i,e){processItem(e,list)})},serialise:function(){return this.serialize()},reset:function(){this.mouse={offsetX:0,offsetY:0,startX:0,startY:0,lastX:0,lastY:0,nowX:0,nowY:0,distX:0,distY:0,dirAx:0,dirX:0,dirY:0,lastDirX:0,lastDirY:0,distAxX:0,distAxY:0},this.isTouch=!1,this.moving=!1,this.dragEl=null,this.dragRootEl=null,this.dragDepth=0,this.hasNewRoot=!1,this.pointEl=null},expandItem:function(li){li.removeClass(this.options.collapsedClass),li.children('[data-action="expand"]').hide(),li.children('[data-action="collapse"]').show(),li.children(this.options.listNodeName).show()},collapseItem:function(li){var lists=li.children(this.options.listNodeName);lists.length&&(li.addClass(this.options.collapsedClass),li.children('[data-action="collapse"]').hide(),li.children('[data-action="expand"]').show(),li.children(this.options.listNodeName).hide())},expandAll:function(cb){var list=this;list.el.find(list.options.itemNodeName).each(function(){var item=$(this);cb&&cb(item)?list.expandItem($(this)):list.expandItem($(this))})},collapseAll:function(cb){var list=this;list.el.find(list.options.itemNodeName).each(function(){var item=$(this);cb&&cb(item)?list.collapseItem(item):list.expandItem(item)})},setParent:function(li,force){if(li.children(this.options.listNodeName).length||force){li.prepend($(this.options.expandBtnHTML)),li.prepend($(this.options.collapseBtnHTML));var handle=li.find("."+this.options.handleClass).first().clone();li.find("."+this.options.handleClass).first().remove(),li.prepend(handle)}li.children('[data-action="expand"]').hide()},unsetParent:function(li){li.removeClass(this.options.collapsedClass),li.children("[data-action]").remove(),li.children(this.options.listNodeName).remove()},dragStart:function(e){var mouse=this.mouse,target=$(e.target),dragItem=target.closest(this.options.itemNodeName);this.placeEl.css("height",dragItem.height()),mouse.offsetX=e.offsetX!==undefined?e.offsetX:e.pageX-target.offset().left,mouse.offsetY=e.offsetY!==undefined?e.offsetY:e.pageY-target.offset().top,mouse.startX=mouse.lastX=e.pageX,mouse.startY=mouse.lastY=e.pageY,this.dragRootEl=this.el,this.dragEl=$(document.createElement(this.options.listNodeName)).addClass(this.options.listClass+" "+this.options.dragClass),this.dragEl.css("width",dragItem.width()),dragItem.after(this.placeEl),dragItem[0].parentNode.removeChild(dragItem[0]),dragItem.appendTo(this.dragEl),$(document.body).append(this.dragEl),this.dragEl.css({left:e.pageX-mouse.offsetX,top:e.pageY-mouse.offsetY});var i,depth,items=this.dragEl.find(this.options.itemNodeName);for(i=0;i<items.length;i++)depth=$(items[i]).parents(this.options.listNodeName).length,depth>this.dragDepth&&(this.dragDepth=depth)},dragStop:function(e){var el=this.dragEl.children(this.options.itemNodeName).first();el[0].parentNode.removeChild(el[0]),this.placeEl.replaceWith(el),this.dragEl.remove(),this.el.trigger("change"),this.hasNewRoot&&this.dragRootEl.trigger("change"),this.reset()},dragMove:function(e){var list,parent,prev,next,depth,opt=this.options,mouse=this.mouse;this.dragEl.css({left:e.pageX-mouse.offsetX,top:e.pageY-mouse.offsetY}),mouse.lastX=mouse.nowX,mouse.lastY=mouse.nowY,mouse.nowX=e.pageX,mouse.nowY=e.pageY,mouse.distX=mouse.nowX-mouse.lastX,mouse.distY=mouse.nowY-mouse.lastY,mouse.lastDirX=mouse.dirX,mouse.lastDirY=mouse.dirY,mouse.dirX=0===mouse.distX?0:mouse.distX>0?1:-1,mouse.dirY=0===mouse.distY?0:mouse.distY>0?1:-1;var newAx=Math.abs(mouse.distX)>Math.abs(mouse.distY)?1:0;if(!mouse.moving)return mouse.dirAx=newAx,void(mouse.moving=!0);mouse.dirAx!==newAx?(mouse.distAxX=0,mouse.distAxY=0):(mouse.distAxX+=Math.abs(mouse.distX),0!==mouse.dirX&&mouse.dirX!==mouse.lastDirX&&(mouse.distAxX=0),mouse.distAxY+=Math.abs(mouse.distY),0!==mouse.dirY&&mouse.dirY!==mouse.lastDirY&&(mouse.distAxY=0)),mouse.dirAx=newAx,mouse.dirAx&&mouse.distAxX>=opt.threshold&&(mouse.distAxX=0,prev=this.placeEl.prev(opt.itemNodeName),mouse.distX>0&&prev.length&&!prev.hasClass(opt.collapsedClass)&&(list=prev.find(opt.listNodeName).last(),depth=this.placeEl.parents(opt.listNodeName).length,depth+this.dragDepth<=opt.maxDepth&&(list.length?(list=prev.children(opt.listNodeName).last(),list.append(this.placeEl)):(list=$("<"+opt.listNodeName+"/>").addClass(opt.listClass),list.append(this.placeEl),prev.append(list),this.setParent(prev)))),mouse.distX<0&&(next=this.placeEl.next(opt.itemNodeName),next.length&&this.placeEl.before(next),next.length||(parent=this.placeEl.parent(),this.placeEl.closest(opt.itemNodeName).after(this.placeEl),parent.children().length||this.unsetParent(parent.parent()))));var isEmpty=!1;if(hasPointerEvents||(this.dragEl[0].style.visibility="hidden"),this.pointEl=$(document.elementFromPoint(e.pageX-document.body.scrollLeft,e.pageY-(window.pageYOffset||document.documentElement.scrollTop))),hasPointerEvents||(this.dragEl[0].style.visibility="visible"),this.pointEl.hasClass(opt.handleClass)&&(this.pointEl=this.pointEl.parent(opt.itemNodeName)),this.pointEl.hasClass(opt.emptyClass))isEmpty=!0;else if(!this.pointEl.length||!this.pointEl.hasClass(opt.itemClass))return;var pointElRoot=this.pointEl.closest("."+opt.rootClass),isNewRoot=this.dragRootEl.data("domenu-id")!==pointElRoot.data("domenu-id");if(!mouse.dirAx||isNewRoot||isEmpty){if(isNewRoot&&opt.group!==pointElRoot.data("domenu-group"))return;if(depth=this.dragDepth-1+this.pointEl.parents(opt.listNodeName).length,depth>opt.maxDepth)return;var before=e.pageY<this.pointEl.offset().top+this.pointEl.height()/2;parent=this.placeEl.parent(),isEmpty?(list=$(document.createElement(opt.listNodeName)).addClass(opt.listClass),list.append(this.placeEl),this.pointEl.replaceWith(list)):before?this.pointEl.before(this.placeEl):this.pointEl.after(this.placeEl),parent.children().length||this.unsetParent(parent.parent()),this.dragRootEl.find(opt.itemNodeName).length||this.dragRootEl.append('<div class="'+opt.emptyClass+'"/>'),isNewRoot&&(this.dragRootEl=pointElRoot,this.hasNewRoot=this.el[0]!==this.dragRootEl[0])}}},PublicPlugin.prototype={getLists:function(params){return this._lists},parseJson:function(data,override){var data=data||null,override=override||!1;return this._plugin.deserialize(data,override),this},toJson:function(){var data=this._plugin.serialize();return JSON.stringify(data)},expandAll:function(){return this._plugin.expandAll(),this},collapseAll:function(){return this._plugin.collapseAll(),this},expand:function(cb){return this._plugin.expandAll(cb),this},collapse:function(cb){return this._plugin.collapseAll(cb),this},getListNodes:function(cb){var opt=this._plugin.options,listNodes=this._plugin.el.find(opt.listNodeName);return listNodes}},$.fn.domenu=function(params){lists=this.first();var plugin,pPlugin,retval=null;return lists.each(function(){$(this).data("domenu")?"string"==typeof params&&("function"==typeof pPlugin[params]?retval=pPlugin[params]():"function"==typeof plugin[params]&&(retval=plugin[params]())):($(this).data("domenu",new Plugin(this,params)),$(this).data("domenu-id",(new Date).getTime()),plugin=$(this).data("domenu"),pPlugin=new PublicPlugin(plugin,lists))}),plugin=$(this).data("domenu"),pPlugin=new PublicPlugin(plugin,lists),retval||pPlugin}}(window.jQuery||window.Zepto,window,document);